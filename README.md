# Context CLI (`ctx-cli`)

A CLI tool that parses intent artifacts and code deltas from any AI coding assistant to generate human-quality commit messages and PR descriptions.

## Features

- **Universal AI Support**: Works with any AI coding assistant through a provider-based architecture
- **Context-Aware**: Reads intent artifacts (task lists, plans, decisions) to understand the *why* behind your changes
- **Diff-Aware**: Analyzes your staged changes (`git diff --staged`) to understand the *what*
- **AI-Powered**: Uses LLMs to synthesize this information into semantic commit messages and comprehensive PR descriptions

### Supported AI Assistants

- ✅ **Antigravity Agent** - Reads task.md and implementation_plan.md from brain directory
- 🚧 **Cursor IDE** - Coming soon
- 🚧 **Aider** - Coming soon

## Installation

Install directly from the repository:

```bash
git clone https://github.com/30signals/ctx-cli.git
cd ctx-cli
npm install
npm run build
npm install -g .
```

Now you can run:

```bash
ctx --help
ctx --version
```

## Configuration

Create a `.env` file in your **home directory** or **project root**. The tool will search for `.env` in the current directory first, then fall back to the home directory.

**For Standard OpenAI:**
```env
OPENAI_API_KEY=sk-your-api-key-here
OPENAI_MODEL=gpt-4o-mini
```

**For Azure OpenAI:**
```env
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com
AZURE_OPENAI_API_KEY=your-azure-api-key
AZURE_OPENAI_DEPLOYMENT=your-deployment-name
AZURE_OPENAI_API_VERSION=2024-02-15-preview
```

> **Note**: The tool automatically detects which provider to use. If `AZURE_OPENAI_ENDPOINT` is set, it will use Azure OpenAI; otherwise, it uses standard OpenAI.

**Optional Settings:**
```env
# Specify which AI assistant to use (auto-detect if not set)
# INTENT_PROVIDER=antigravity

# Custom Antigravity brain directory
# ANTIGRAVITY_BRAIN_DIR=C:/Users/username/.gemini/antigravity/brain
```

### Using Environment Variables

Instead of using a `.env` file, you can export configuration directly as environment variables. This is particularly useful for CI/CD pipelines, Docker containers, or production deployments.

**Linux/macOS:**
```bash
export OPENAI_API_KEY=sk-your-api-key-here
export OPENAI_MODEL=gpt-4o-mini
ctx commit
```

**Windows (PowerShell):**
```powershell
$env:OPENAI_API_KEY="sk-your-api-key-here"
$env:OPENAI_MODEL="gpt-4o-mini"
ctx commit
```

**Windows (Command Prompt):**
```cmd
set OPENAI_API_KEY=sk-your-api-key-here
set OPENAI_MODEL=gpt-4o-mini
ctx commit
```

**Docker:**
```bash
docker run -e OPENAI_API_KEY=sk-your-key -e OPENAI_MODEL=gpt-4o-mini your-image
```

> **Note**: Environment variables take precedence over `.env` file values. The tool will use environment variables first, then fall back to `.env` file configuration.


## Usage

### Generate Commit Message

Stage your files first:
```bash
git add .
```

Then run:
```bash
ctx commit
```

**Options:**
- `--no-tradeoffs`: Skip the "Trade-offs" section.
- `--ai-attribution`: Add a "Generated by <AI Assistant>" footer.
- `--dry-run`: Print the generated message to stdout and exit.
- `-a`, `--all`: Stage all changes (untracked + modified) before generating the message.
- `-c`, `--context <text>`: Add custom context to include in the generation (e.g., issue numbers, breaking changes).

**Examples:**
```bash
# Add context about an issue fix
ctx commit -c "Fixes #123"

# Add context about a breaking change
ctx commit --context "Breaking change: removed deprecated API"

# Combine with other options
ctx commit -a --context "Security fix for CVE-2024-1234" --dry-run
```

### Generate PR Description

Run the `pr` command (compares `HEAD` to `main` by default):

```bash
ctx pr
```

**Options:**
- `--no-tradeoffs`
- `--ai-attribution`
- `-c`, `--context <text>`: Add custom context to include in the generation

## How it Works

ctx-cli uses an **Intent Provider** architecture to support multiple AI coding assistants:

1.  **Provider Detection**: The tool auto-detects which AI assistant you're using by checking for specific artifacts (e.g., Antigravity brain directory, Aider chat logs, Cursor rules).
2.  **Intent Collection**: The detected provider collects and normalizes intent data into a common schema with goals, tasks, decisions, trade-offs, and constraints.
3.  **Diff Analysis**: Git changes are extracted from `git diff --staged` (for commits) or branch comparisons (for PRs).
4.  **Synthesis**: The normalized intent context and diff are sent to an LLM to generate human-quality commit messages or PR descriptions.

### Adding New Providers

To support a new AI assistant, implement the `IntentProvider` interface:

```typescript
interface IntentProvider {
  name: string;
  detect(): Promise<boolean>;
  collect(): Promise<IntentBundle | null>;
}
```

See `src/providers/` for examples.

## Development

### Local Setup

1. Clone the repository and install dependencies:
   ```bash
   git clone https://github.com/30signals/ctx-cli.git
   cd ctx-cli
   npm install
   ```

2. Create a `.env` file with your API keys (see Configuration section)

3. Build and install globally:
   ```bash
   npm run build
   npm install -g .
   ```
   
   Now you can use `ctx` from anywhere on your system.

### Testing Changes

After making changes:

1. Rebuild and reinstall:
   ```bash
   npm run build
   npm install -g .
   ```

2. Test in a git repository:
   ```bash
   cd /path/to/test/repo
   git add .
   ctx commit --dry-run
   ```

